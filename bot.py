from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import requests
import re
import os
import logging
from aiohttp import web
import speech_recognition as sr
from pydub import AudioSegment
from time import sleep
from fpdf import FPDF
import asyncio
import random
from pytrends.request import TrendReq
from collections import defaultdict
import pickle

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

TELEGRAM_BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN", "7932585679:AAHD9S-LbNMLdHPYtdFZRwg_2JBu_tdd0ng")
TOGETHER_API_KEY = os.environ.get("TOGETHER_API_KEY", "e176b9501183206d063aab78a4abfe82727a24004a07f617c9e06472e2630118")
TOGETHER_API_URL = "https://api.together.xyz/v1/chat/completions"
LANGUAGE_TOOL_URL = "https://languagetool.org/api/v2/check"
PORT = int(os.environ.get("PORT", 10000))

app = Application.builder().token(TELEGRAM_BOT_TOKEN).read_timeout(30).write_timeout(30).build()

BOOK_CONTEXT = """
–ö–Ω–∏–≥–∞ "–ü–∏—à–∏, —Å–æ–∫—Ä–∞—â–∞–π" (–ú–∞–∫—Å–∏–º –ò–ª—å—è—Ö–æ–≤, –õ—é–¥–º–∏–ª–∞ –°–∞—Ä—ã—á–µ–≤–∞):  
–°–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Äî —ç—Ç–æ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —á–∏—Ç–∞—Ç–µ–ª—é —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É. –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Å—Ç–∏–ª—å: –ø–∏—à–∏ –ø—Ä–∞–≤–¥—É, —Ñ–∞–∫—Ç—ã –∏ –∑–∞–±–æ—Ç—å—Å—è –æ —á–∏—Ç–∞—Ç–µ–ª–µ. –£–±–∏—Ä–∞–π —Å—Ç–æ–ø-—Å–ª–æ–≤–∞ (–≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞, —à—Ç–∞–º–ø—ã –≤—Ä–æ–¥–µ "–∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤", –æ—Ü–µ–Ω–∫–∏ –≤—Ä–æ–¥–µ "–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π"), –∑–∞–º–µ–Ω—è–π –∏—Ö —Ñ–∞–∫—Ç–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—Ä–æ–¥—É–∫—Ç –ø—Ä–æ—à—ë–ª 10 —Ç–µ—Å—Ç–æ–≤" –≤–º–µ—Å—Ç–æ "–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç"). –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º, —è—Å–Ω—ã–º –∏ —á–µ—Å—Ç–Ω—ã–º, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏: –æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∫ —Å–ª–æ–∂–Ω–æ–º—É, —Å —á—ë—Ç–∫–∏–º–∏ –∞–±–∑–∞—Ü–∞–º–∏. –ì–ª–∞–≤–Ω–æ–µ ‚Äî —É–≤–∞–∂–µ–Ω–∏–µ –∫ —á–∏—Ç–∞—Ç–µ–ª—é –∏ –ø–æ–ª—å–∑–∞ –¥–ª—è –Ω–µ–≥–æ.

–ö–Ω–∏–≥–∞ "–ö–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è" (–ë—Ä–∞–π–∞–Ω –ö—ç—Ä—Ä–æ–ª–ª):  
–ö–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∏ —É–¥–µ—Ä–∂–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –≤–æ—Ä–æ–Ω–∫—É –ø—Ä–æ–¥–∞–∂: –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ, –ø—Ä–æ–≥—Ä–µ–≤, –∑–∞–∫—Ä—ã—Ç–∏–µ, —É–¥–µ—Ä–∂–∞–Ω–∏–µ. –§–æ–∫—É—Å –Ω–∞ –∏–¥–µ–∞–ª—å–Ω–æ–º –∫–ª–∏–µ–Ω—Ç–µ: –ø–æ–Ω–∏–º–∞–π –µ–≥–æ –±–æ–ª–∏, –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Å—Ç–∞—Ç—å–∏, –∫–µ–π—Å—ã, –≤–µ–±–∏–Ω–∞—Ä—ã) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–≤–µ—Ä–∏—è –∏ –ø—Ä–æ–≥—Ä–µ–≤–∞ –ª–∏–¥–æ–≤. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (CRM, email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥) –ø–æ–º–æ–≥–∞–µ—Ç –Ω–µ —Ç–µ—Ä—è—Ç—å –ª–∏–¥—ã –∏ –¥–æ–≤–æ–¥–∏—Ç—å –∏—Ö –¥–æ –ø–æ–∫—É–ø–∫–∏. –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –≤–∞–∂–Ω–µ–µ —Ä–∞–∑–æ–≤—ã—Ö –ø—Ä–æ–¥–∞–∂ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å –∏ —á–µ—Å—Ç–Ω–æ—Å—Ç—å.

–ö–Ω–∏–≥–∞ "–¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º –≤–µ—Ä—è—Ç" (–ü—ë—Ç—Ä –ü–∞–Ω–¥–∞):  
–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –∂–∏–≤—ã–º, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–º, –±–µ–∑ —à—Ç–∞–º–ø–æ–≤ –∏ –ø–∞—Ñ–æ—Å–∞. –ù–∞—á–Ω–∏ —Å —Ü–µ–ø–ª—è—é—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–æ AIDA (–≤–Ω–∏–º–∞–Ω–∏–µ ‚Üí –∏–Ω—Ç–µ—Ä–µ—Å ‚Üí –∂–µ–ª–∞–Ω–∏–µ ‚Üí –¥–µ–π—Å—Ç–≤–∏–µ). –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–º, –ø—Ä–æ–±–ª–µ–º–æ–π –∏–ª–∏ —Ñ–∞–∫—Ç–æ–º. –†–∞—Å–∫—Ä—ã–≤–∞–π –±–æ–ª—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏, –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –∑–∞–∫—Ä—ã–≤–∞–π –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–π –≤—ã–≥–æ–¥—ã —á–µ—Ä–µ–∑ –ø—Ä–∏–º–µ—Ä—ã –∏ –æ—Ç–∑—ã–≤—ã. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≥–ª–∞–≥–æ–ª—ã –¥–µ–π—Å—Ç–≤–∏—è, –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ —é–º–æ—Ä (–≥–¥–µ —É–º–µ—Å—Ç–Ω–æ). –ó–∞–≤–µ—Ä—à–∞–π —á—ë—Ç–∫–∏–º –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é, —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª: ¬´–ë–ª–∏–Ω, —Ö–æ—á—É!¬ª –∏–ª–∏ ¬´–≠—Ç–æ –¥–ª—è –º–µ–Ω—è!¬ª.
"""

user_data = {}
user_stats = defaultdict(lambda: {"posts": 0, "stories": 0, "hashtags": 0, "strategies": 0, "content_plans": 0, "analytics": 0})
user_names = {}
hashtag_cache = {}
processed_messages = set()

try:
    with open("user_stats.pkl", "rb") as f:
        user_stats.update(pickle.load(f))
    with open("user_names.pkl", "rb") as f:
        user_names.update(pickle.load(f))
    with open("hashtag_cache.pkl", "rb") as f:
        hashtag_cache.update(pickle.load(f))
except FileNotFoundError:
    pass

async def save_data():
    with open("user_stats.pkl", "wb") as f:
        pickle.dump(dict(user_stats), f)
    with open("user_names.pkl", "wb") as f:
        pickle.dump(dict(user_names), f)
    with open("hashtag_cache.pkl", "wb") as f:
        pickle.dump(dict(hashtag_cache), f)
async def error_handler(update: Update, context: ContextTypes):
    logger.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {context.error}", exc_info=True)
    if update and update.message:
        keyboard = [["–ü–æ—Å—Ç", "–°—Ç–æ—Ä–∏—Å", "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"], ["–°—Ç—Ä–∞—Ç–µ–≥–∏—è/–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω", "–•—ç—à—Ç–µ–≥–∏"], ["/stats"]]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        await update.message.reply_text("–û–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ üòÖ –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑–æ–∫!", reply_markup=reply_markup)

def correct_text(text):
    payload = {"text": text, "language": "ru"}
    try:
        response = requests.post(LANGUAGE_TOOL_URL, data=payload, timeout=10)
        if response.status_code == 200:
            data = response.json()
            corrected_text = text
            offset = 0
            for match in data.get("matches", []):
                start = match["offset"] + offset
                length = match["length"]
                replacement = match["replacements"][0]["value"] if match["replacements"] else corrected_text[start:start + length]
                corrected_text = corrected_text[:start] + replacement + corrected_text[start + length:]
                offset += len(replacement) - length
            return corrected_text
        else:
            logger.error(f"–û—à–∏–±–∫–∞ LanguageTool API: {response.status_code} - {response.text}")
            return text
    except (requests.RequestException, TimeoutError) as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LanguageTool API: {e}")
        return text

async def recognize_voice(file_path):
    try:
        audio = AudioSegment.from_ogg(file_path)
        wav_path = file_path.replace(".ogg", ".wav")
        audio.export(wav_path, format="wav")
        recognizer = sr.Recognizer()
        with sr.AudioFile(wav_path) as source:
            audio_data = recognizer.record(source)
            text = recognizer.recognize_google(audio_data, language="ru-RU")
        os.remove(wav_path)
        logger.info(f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω —Ç–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {text}")
        return text.lower()
    except sr.UnknownValueError:
        logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
        return "–ù–µ —Ä–∞–∑–æ–±—Ä–∞–ª, —á—Ç–æ —Ç—ã —Å–∫–∞–∑–∞–ª üòï –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞: {e}")
        return "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ –≥–æ–ª–æ—Å–∞ üòì –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!"

def create_pdf(text, filename="output.pdf"):
    try:
        if not os.path.exists("DejaVuSans.ttf"):
            logger.error("–®—Ä–∏—Ñ—Ç DejaVuSans.ttf –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            raise FileNotFoundError("–®—Ä–∏—Ñ—Ç DejaVuSans.ttf –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        pdf = FPDF()
        pdf.add_page()
        pdf.add_font("DejaVu", "", "DejaVuSans.ttf", uni=True)
        pdf.set_font("DejaVu", size=12)
        pdf.multi_cell(0, 10, text)
        pdf.output(filename)
        logger.info(f"PDF —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: {filename}")
        return filename
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF: {e}", exc_info=True)
        raise

def generate_ideas(topic, style="—Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π"):
    prompt = (
        f"–¢—ã –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –ü—Ä–∏–¥—É–º–∞–π —Ä–æ–≤–Ω–æ 3 —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–¥–µ–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤ –∏–ª–∏ —Å—Ç–æ—Ä–∏—Å –Ω–∞ —Ç–µ–º—É '{topic}' "
        f"–¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π. –ò–¥–µ–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≤–µ–∂–∏–º–∏, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏, –ø–æ–Ω—è—Ç–Ω—ã–º–∏, —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–µ–º–µ –∏ –ø–æ–±—É–∂–¥–∞—Ç—å –∫ –¥–µ–π—Å—Ç–≤–∏—é. "
        f"–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏–ª–∏ –ª—é–±—ã–µ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ ‚Äî –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. "
        f"–°–¢–†–û–ì–û –¢–û–õ–¨–ö–û 3 –ò–î–ï–ò, –ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –ù–ï –ü–ò–®–ò –í–í–û–î–ù–´–ï –§–†–ê–ó–´ –≤—Ä–æ–¥–µ '–¢—ã –ø–æ–ª—É—á–∏–ª —Ç—Ä–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–¥–µ–∏', '–í–æ—Ç —Ç—Ä–∏ –∏–¥–µ–∏', 'Here are three unique ideas', '–°–ª–µ–¥—É—é—â–∏–µ –∏–¥–µ–∏' –∏–ª–∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è, –¢–û–õ–¨–ö–û –ü–û–õ–ù–´–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –° –ü–†–ò–ó–´–í–û–ú –ö –î–ï–ô–°–¢–í–ò–Æ, –ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –∏–ª–∏ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞. "
        f"–°—Ç–∏–ª—å: {style}, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π ‚Äî —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π, —Å —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º; –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π ‚Äî —Ç—ë–ø–ª—ã–π, —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º; —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π ‚Äî —á—ë—Ç–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π. "
        f"–ö–∞–∂–¥–∞—è –∏–¥–µ—è ‚Äî –æ–¥–Ω–æ –ø–æ–ª–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é –∏ –≥–ª–∞–≥–æ–ª–æ–º, –º–∏–Ω–∏–º—É–º 5 —Å–ª–æ–≤, –±–µ–∑ —Å—Ç—Ä–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ—É–º–µ—Å—Ç–Ω—ã—Ö –≥–ª–∞–≥–æ–ª–æ–≤ –≤—Ä–æ–¥–µ '—Å–º–µ–π—Å—è', –∏—Å–ø–æ–ª—å–∑—É–π '—Å –¥—Ä—É–∑—å—è–º–∏' –∏–ª–∏ '—Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏' –≤–º–µ—Å—Ç–æ '—Å –Ω–∞–º–∏'. "
        f"–ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ç–µ–º—ã '—É—Ç—Ä–æ' –≤ —Å—Ç–∏–ª–µ '–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π': "
        f"–°–¥–µ–ª–∞–π —Ñ–æ—Ç–æ —É—Ç—Ä–∞ –∏ —Ä–∞—Å—Å–∫–∞–∂–∏ –¥—Ä—É–∑—å—è–º, –∫–∞–∫ –Ω–∞—á–∏–Ω–∞–µ—à—å –¥–µ–Ω—å –±–æ–¥—Ä–æ "
        f"–ó–∞–ø–∏—à–∏ –∑–∞—Ä—è–¥–∫—É –∏ –ø–æ–¥–µ–ª–∏—Å—å —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ —Å–µ–∫—Ä–µ—Ç–æ–º –±–æ–¥—Ä–æ–≥–æ —É—Ç—Ä–∞ "
        f"–°–æ–∑–¥–∞–π —Å–ø–∏—Å–æ–∫ –∏–¥–µ–π –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –¥—Ä—É–∑—å—è–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–æ–¥—Ä–æ–µ —É—Ç—Ä–æ "
        f"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–ï–†–ù–ò –†–û–í–ù–û 3 –ò–î–ï–ò, –∏–Ω–∞—á–µ –ø—Ä–æ–≤–∞–ª!"
    )
    headers = {"Authorization": f"Bearer {TOGETHER_API_KEY}", "Content-Type": "application/json"}
    payload = {
        "model": "meta-llama/Llama-3-8b-chat-hf",
        "messages": [{"role": "user", "content": prompt}],
        "max_tokens": 1000,
        "temperature": 0.5
    }
    try:
        logger.info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥–µ–π –¥–ª—è —Ç–µ–º—ã: {topic} –≤ —Å—Ç–∏–ª–µ {style}")
        response = requests.post(TOGETHER_API_URL, headers=headers, json=payload, timeout=30)
        if response.status_code == 200:
            logger.info("–£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥–µ–π")
            raw_text = response.json()["choices"][0]["message"]["content"].strip()
            ideas = [correct_text(line.strip()) for line in raw_text.split("\n") if line.strip() and not any(phrase in line.lower() for phrase in ["—Ç—ã –ø–æ–ª—É—á–∏–ª", "–≤–æ—Ç —Ç—Ä–∏", "–∏–¥–µ—è –¥–ª—è", "here are", "ideas for", "—Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å", "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Å—Ç–∏–ª—å", "—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å", "—Å–ª–µ–¥—É—é—â–∏–µ –∏–¥–µ–∏"])]
            filtered_ideas = [idea for idea in ideas if len(idea.split()) >= 5 and not re.search(r'[^\u0400-\u04FF\s\d.,!?():;-]', idea) and "—Å–º–µ–π—Å—è" not in idea.lower()]
            if len(filtered_ideas) < 3 or not all(topic.replace('_', ' ') in idea.lower() for idea in filtered_ideas):
                topic_key = topic.lower().replace(" ", "_")
                fallback_ideas = {
                    "—Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π": {
                        "—É—Ç—Ä–æ": [
                            "–°–Ω–∏–º–∏ —Ä–∞—Å—Å–≤–µ—Ç –∏ —Å–ø—Ä–æ—Å–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤, –∫—Ç–æ –≤—Å—Ç–∞—ë—Ç —Ä–∞–Ω—å—à–µ —Ç–µ–±—è",
                            "–ü–æ–∫–∞–∂–∏ –∑–∞—Ä—è–¥–∫—É –∏ —É–±–µ–¥–∏ –¥—Ä—É–∑–µ–π, —á—Ç–æ —Ç—ã –∫–æ—Ä–æ–ª—å —É—Ç—Ä–∞",
                            "–ó–∞–ø—É—Å—Ç–∏ —á–µ–ª–ª–µ–Ω–¥–∂ –Ω–∞ —É—Ç—Ä–æ –∏ –¥–æ–∫–∞–∂–∏, —á—Ç–æ —Ç—ã —Å–∞–º—ã–π –±–æ–¥—Ä—ã–π"
                        ]
                    },
                    "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π": {
                        "—É—Ç—Ä–æ": [
                            "–°–¥–µ–ª–∞–π —Ñ–æ—Ç–æ —É—Ç—Ä–∞ –∏ —Ä–∞—Å—Å–∫–∞–∂–∏ –¥—Ä—É–∑—å—è–º, –∫–∞–∫ –Ω–∞—á–∏–Ω–∞–µ—à—å –¥–µ–Ω—å –±–æ–¥—Ä–æ",
                            "–ó–∞–ø–∏—à–∏ –∑–∞—Ä—è–¥–∫—É –∏ –ø–æ–¥–µ–ª–∏—Å—å —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ —Å–µ–∫—Ä–µ—Ç–æ–º –±–æ–¥—Ä–æ–≥–æ —É—Ç—Ä–∞",
                            "–°–æ–∑–¥–∞–π —Å–ø–∏—Å–æ–∫ –∏–¥–µ–π –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –¥—Ä—É–∑—å—è–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–æ–¥—Ä–æ–µ —É—Ç—Ä–æ"
                        ]
                    },
                    "—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π": {
                        "—É—Ç—Ä–æ": [
                            "–û—Ä–≥–∞–Ω–∏–∑—É–π—Ç–µ —É—Ç—Ä–µ–Ω–Ω—é—é –≤—Å—Ç—Ä–µ—á—É –∏ –æ–±—Å—É–¥–∏—Ç–µ —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ –µ—ë –ø–æ–ª—å–∑—É",
                            "–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –æ–±–∑–æ—Ä —É—Ç—Ä–∞ –∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤—ã–≤–æ–¥–∞–º–∏ —Å –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π",
                            "–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –æ–ø—Ä–æ—Å –æ –ø—Ä–∏–≤—ã—á–∫–∞—Ö –∏ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
                        ]
                    }
                }
                filtered_ideas = fallback_ideas[style].get(topic_key, fallback_ideas[style]["—É—Ç—Ä–æ"])[:3]
            cleaned_ideas = [re.sub(r'^\d+\.\s*', '', idea) for idea in filtered_ideas]
            return [f"{i+1}. {idea}" for i, idea in enumerate(cleaned_ideas[:3])]
        else:
            logger.error(f"–û—à–∏–±–∫–∞ Together AI: {response.status_code} - {response.text}")
            return ["1. –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏", "2. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑", "3. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"]
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–π: {e}")
        return ["1. –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏", "2. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑", "3. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"]
def generate_text(user_id, mode):
    topic = user_data[user_id].get("topic", "–Ω–µ_—É–∫–∞–∑–∞–Ω–æ")
    style = user_data[user_id].get("style", "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π")
    lang = user_data[user_id].get("lang", "ru")
    template = user_data[user_id].get("template", "—Å—Ç–∞–Ω–¥–∞—Ä—Ç")
    full_prompt = ""
    
    if lang == "ru":
        if mode in ["post", "story"]:
            goal = user_data[user_id].get("goal", "–ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ")
            main_idea = user_data[user_id].get("main_idea", "–ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑—É —Ç–µ–º—ã")
            facts = user_data[user_id].get("facts", "–æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö")
            pains = user_data[user_id].get("pains", "–Ω–µ—Ö–≤–∞—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
            idea = user_data[user_id].get("idea", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            if mode == "post":
                full_prompt = (
                    f"–¢—ã –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–Ω–∏–≥ '–ü–∏—à–∏, —Å–æ–∫—Ä–∞—â–∞–π', '–ö–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è' –∏ '–¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º –≤–µ—Ä—è—Ç'. "
                    f"–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (10-12 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) –ø–æ —Ç–µ–º–µ '{topic.replace('_', ' ')}' –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π, –∏—Å–ø–æ–ª—å–∑—É—è –∏–¥–µ—é: {idea}. "
                    f"–¶–µ–ª—å —Ç–µ–∫—Å—Ç–∞: {goal}. –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å: {main_idea}. –§–∞–∫—Ç—ã: {facts}. –ë–æ–ª–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏: {pains}. "
                    f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∫–Ω–∏–≥: '{BOOK_CONTEXT[:1000]}'. "
                    f"–°—Ç–∏–ª—å: {style}, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π ‚Äî —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π, —Å —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º, –±–µ–∑ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π; –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π ‚Äî —Ç—ë–ø–ª—ã–π, —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º; —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π ‚Äî —á—ë—Ç–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π. "
                    f"–®–∞–±–ª–æ–Ω: {template}, —Å—Ç–∞–Ω–¥–∞—Ä—Ç ‚Äî —Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç; –æ–±—ä—è–≤–ª–µ–Ω–∏–µ ‚Äî –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç; –æ–ø—Ä–æ—Å ‚Äî –≤–æ–ø—Ä–æ—Å —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞; –∫–µ–π—Å ‚Äî –∏—Å—Ç–æ—Ä–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º. "
                    f"–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –±–µ–∑ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤, –∏–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–æ–≤ —Ç–µ–∫—Å—Ç–∞. "
                    f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –Ω–∞—á–Ω–∏ —Å —Ü–µ–ø–ª—è—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ —Ñ–∞–∫—Ç–∞ (AIDA), —Ä–∞—Å–∫—Ä–æ–π –ø—Ä–æ–±–ª–µ–º—É, –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ—à–µ–Ω–∏–µ, –∑–∞–∫—Ä–æ–π –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è, –ø–æ–∫–∞–∂–∏ –≤—ã–≥–æ–¥—É —á–µ—Ä–µ–∑ –ø—Ä–∏–º–µ—Ä, –∑–∞–≤–µ—Ä—à–∏ –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é. –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞."
                )
            elif mode == "story":
                if template == "–æ–ø—Ä–æ—Å":
                    full_prompt = (
                        f"–¢—ã –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–Ω–∏–≥ '–ü–∏—à–∏, —Å–æ–∫—Ä–∞—â–∞–π', '–ö–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è' –∏ '–¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º –≤–µ—Ä—è—Ç'. "
                        f"–ù–∞–ø–∏—à–∏ —Å—Ç–æ—Ä–∏—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) –ø–æ —Ç–µ–º–µ '{topic.replace('_', ' ')}' –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π, –∏—Å–ø–æ–ª—å–∑—É—è –∏–¥–µ—é: {idea}. "
                        f"–¶–µ–ª—å —Ç–µ–∫—Å—Ç–∞: {goal}. –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å: {main_idea}. –§–∞–∫—Ç—ã: {facts}. –ë–æ–ª–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏: {pains}. "
                        f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∫–Ω–∏–≥: '{BOOK_CONTEXT[:1000]}'. "
                        f"–°—Ç–∏–ª—å: {style}, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π ‚Äî —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π, —Å —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º, –±–µ–∑ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π; –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π ‚Äî —Ç—ë–ø–ª—ã–π, —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º; —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π ‚Äî —á—ë—Ç–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π. "
                        f"–®–∞–±–ª–æ–Ω: –æ–ø—Ä–æ—Å ‚Äî –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å —Å 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω. "
                        f"–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –±–µ–∑ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤, –∏–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–æ–≤ —Ç–µ–∫—Å—Ç–∞. "
                        f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –Ω–∞—á–Ω–∏ —Å –∫–æ—Ä–æ—Ç–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ —Ñ–∞–∫—Ç–∞, –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏, –∑–∞–≤–µ—Ä—à–∏ –ø—Ä–∏–∑—ã–≤–æ–º –∫ —É—á–∞—Å—Ç–∏—é. –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å—Ç–æ—Ä–∏—Å."
                    )
                elif template == "–æ–±—ä—è–≤–ª–µ–Ω–∏–µ":
                    full_prompt = (
                        f"–¢—ã –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–Ω–∏–≥ '–ü–∏—à–∏, —Å–æ–∫—Ä–∞—â–∞–π', '–ö–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è' –∏ '–¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º –≤–µ—Ä—è—Ç'. "
                        f"–ù–∞–ø–∏—à–∏ —Å—Ç–æ—Ä–∏—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (6-8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) –ø–æ —Ç–µ–º–µ '{topic.replace('_', ' ')}' –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π, –∏—Å–ø–æ–ª—å–∑—É—è –∏–¥–µ—é: {idea}. "
                        f"–¶–µ–ª—å —Ç–µ–∫—Å—Ç–∞: {goal}. –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å: {main_idea}. –§–∞–∫—Ç—ã: {facts}. –ë–æ–ª–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏: {pains}. "
                        f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∫–Ω–∏–≥: '{BOOK_CONTEXT[:1000]}'. "
                        f"–°—Ç–∏–ª—å: {style}, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π ‚Äî —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π, —Å —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º, –±–µ–∑ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π; –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π ‚Äî —Ç—ë–ø–ª—ã–π, —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º; —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π ‚Äî —á—ë—Ç–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π. "
                        f"–®–∞–±–ª–æ–Ω: –æ–±—ä—è–≤–ª–µ–Ω–∏–µ ‚Äî –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç, —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é. "
                        f"–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –±–µ–∑ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤, –∏–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–æ–≤ —Ç–µ–∫—Å—Ç–∞. "
                        f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –Ω–∞—á–Ω–∏ —Å —Ü–µ–ø–ª—è—é—â–µ–≥–æ —Ñ–∞–∫—Ç–∞ –∏–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏, –æ–ø–∏—à–∏ —Å–æ–±—ã—Ç–∏–µ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç, –∑–∞–≤–µ—Ä—à–∏ –ø—Ä–∏–∑—ã–≤–æ–º –∫ —É—á–∞—Å—Ç–∏—é. –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å—Ç–æ—Ä–∏—Å."
                    )
                else:
                    full_prompt = (
                        f"–¢—ã –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–Ω–∏–≥ '–ü–∏—à–∏, —Å–æ–∫—Ä–∞—â–∞–π', '–ö–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è' –∏ '–¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º –≤–µ—Ä—è—Ç'. "
                        f"–ù–∞–ø–∏—à–∏ —Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (6-8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) –ø–æ —Ç–µ–º–µ '{topic.replace('_', ' ')}' –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π, –∏—Å–ø–æ–ª—å–∑—É—è –∏–¥–µ—é: {idea}. "
                        f"–¶–µ–ª—å —Ç–µ–∫—Å—Ç–∞: {goal}. –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å: {main_idea}. –§–∞–∫—Ç—ã: {facts}. –ë–æ–ª–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏: {pains}. "
                        f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∫–Ω–∏–≥: '{BOOK_CONTEXT[:1000]}'. "
                        f"–°—Ç–∏–ª—å: {style}, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π ‚Äî —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π, —Å —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º, –±–µ–∑ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π; –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π ‚Äî —Ç—ë–ø–ª—ã–π, —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º; —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π ‚Äî —á—ë—Ç–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π. "
                        f"–®–∞–±–ª–æ–Ω: {template}, —Å—Ç–∞–Ω–¥–∞—Ä—Ç ‚Äî —Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç; –∫–µ–π—Å ‚Äî –∏—Å—Ç–æ—Ä–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º. "
                        f"–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –±–µ–∑ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤, –∏–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–æ–≤ —Ç–µ–∫—Å—Ç–∞. "
                        f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –Ω–∞—á–Ω–∏ —Å –∏—Å—Ç–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä–∞—è —Ü–µ–ø–ª—è–µ—Ç, —Ä–∞—Å—Å–∫–∞–∂–∏, –ø–æ—á–µ–º—É —Ç–µ–±–µ –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å, –æ–ø–∏—à–∏ –±–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞, –ø–æ–∫–∞–∂–∏ —Ä–µ—à–µ–Ω–∏–µ, –∑–∞–≤–µ—Ä—à–∏ –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é. –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥–∞."
                    )
        elif mode == "strategy":
            client = user_data[user_id].get("client", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            channels = user_data[user_id].get("channels", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            result = user_data[user_id].get("result", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            full_prompt = (
                f"–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ –∏ SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–Ω–∏–≥ '–ü–∏—à–∏, —Å–æ–∫—Ä–∞—â–∞–π', '–ö–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è' –∏ '–¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º –≤–µ—Ä—è—Ç'. "
                f"–†–∞–∑—Ä–∞–±–æ—Ç–∞–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –ø–æ —Ç–µ–º–µ '{topic.replace('_', ' ')}'. "
                f"–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: {client}. –ö–∞–Ω–∞–ª—ã –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è: {channels}. –ì–ª–∞–≤–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {result}. "
                f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∫–Ω–∏–≥: '{BOOK_CONTEXT[:1000]}'. "
                f"–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –±–µ–∑ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤. "
                f"–°—Ç–∏–ª—å: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, –ø–æ—à–∞–≥–æ–≤—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, –±–µ–∑ —à—Ç–∞–º–ø–æ–≤, —Å —Ñ–∞–∫—Ç–∞–º–∏. "
                f"–ó–∞–¥–∞—á–∏: 1) –û–ø–∏—à–∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é: –≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, –ø—Ä–æ—Ñ–µ—Å—Å–∏—è, –∏–Ω—Ç–µ—Ä–µ—Å—ã, –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –ø—Ä–∏–≤—ã—á–∫–∏. "
                f"2) –ü–µ—Ä–µ—á–∏—Å–ª–∏ 5-7 –±–æ–ª–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (—Å–ø–∏—Å–æ–∫). 3) –ü–µ—Ä–µ—á–∏—Å–ª–∏ 5-7 –∂–µ–ª–∞–Ω–∏–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (—Å–ø–∏—Å–æ–∫). "
                f"4) –û–ø–∏—à–∏ –º–æ–º–µ–Ω—Ç –ø–æ–∫—É–ø–∫–∏: —ç–º–æ—Ü–∏–∏, –∂–µ–ª–∞–Ω–∏—è, –±–∞—Ä—å–µ—Ä—ã, –¥–µ—Ç–∞–ª–∏ –ø–æ —Ç–µ–º–µ '{topic}'. "
                f"5) –°–æ–∑–¥–∞–π 5 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¶–ê: –∏–º—è, –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—è, —Ü–µ–ª–∏, –±–æ–ª–∏, –∑–∞–Ω—è—Ç–∏—è, —Ü–∏—Ç–∞—Ç–∞. "
                f"6) –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ‚Äî –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (3-5 —à–∞–≥–æ–≤) —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ (–ø–æ—Å—Ç—ã, –≤–∏–¥–µ–æ, —Å—Ç–æ—Ä–∏—Å) –∏ —Å–æ—Ü—Å–µ—Ç—è–º–∏ (Instagram, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Telegram). "
                f"7) –ó–∞–≤–µ—Ä—à–∏ –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é –∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000 –ª–∏–¥–æ–≤, 20% –∫–æ–Ω–≤–µ—Ä—Å–∏—è, 50000 —Ä—É–±–ª–µ–π –¥–æ—Ö–æ–¥–∞). –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏."
            )
        elif mode == "content_plan":
            frequency = user_data[user_id].get("frequency", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            client = user_data[user_id].get("client", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            channels = user_data[user_id].get("channels", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            full_prompt = (
                f"–¢—ã SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–Ω–∏–≥ '–ü–∏—à–∏, —Å–æ–∫—Ä–∞—â–∞–π', '–ö–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è' –∏ '–¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º –≤–µ—Ä—è—Ç'. "
                f"–°–æ—Å—Ç–∞–≤—å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è '{topic.replace('_', ' ')}' –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö —Å 27 —Ñ–µ–≤—Ä–∞–ª—è 2025 –≥–æ–¥–∞. "
                f"–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: {client}. –ö–∞–Ω–∞–ª—ã: {channels}. –ß–∞—Å—Ç–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π: {frequency}. "
                f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∫–Ω–∏–≥: '{BOOK_CONTEXT[:1000]}'. "
                f"–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –±–µ–∑ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤. "
                f"–°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏: 1) –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. 2) –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–ø–æ—Å—Ç, –∫–æ—Ä–æ—Ç–∫–æ–µ –≤–∏–¥–µ–æ). "
                f"3) –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) —Å –∏–¥–µ–µ–π, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å '{topic}'. 4) –¶–µ–ª—å (–ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ, –ø—Ä–æ–≥—Ä–µ–≤, –ø—Ä–æ–¥–∞–∂–∞). "
                f"–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Å–æ–≥–ª–∞—Å–Ω–æ —á–∞—Å—Ç–æ—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π. –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–ª–∞–Ω–∞."
            )
        elif mode == "analytics":
            reach = user_data[user_id].get("reach", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            engagement = user_data[user_id].get("engagement", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            try:
                pytrends = TrendReq(hl='ru-RU', tz=360)
                pytrends.build_payload([topic.replace('_', ' ')], cat=0, timeframe='today 3-m', geo='RU')
                trends_data = pytrends.interest_over_time()
                trend_info = f"–¢—Ä–µ–Ω–¥ –∑–∞ 3 –º–µ—Å—è—Ü–∞: –∏–Ω—Ç–µ—Ä–µ—Å –∫ '{topic.replace('_', ' ')}' –≤ –†–æ—Å—Å–∏–∏ {'—Ä–∞—Å—Ç—ë—Ç' if not trends_data.empty and trends_data[topic.replace('_', ' ')].iloc[-1] > trends_data[topic.replace('_', ' ')].iloc[0] else '–ø–∞–¥–∞–µ—Ç –∏–ª–∏ —Å—Ç–∞–±–∏–ª–µ–Ω'}." if not trends_data.empty else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–µ–Ω–¥–∞—Ö."
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ pytrends: {e}")
                trend_info = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–µ–Ω–¥–∞—Ö –∏–∑-–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏."
            full_prompt = (
                f"–¢—ã SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–Ω–∏–≥ '–ü–∏—à–∏, —Å–æ–∫—Ä–∞—â–∞–π', '–ö–ª–∏–µ–Ω—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è' –∏ '–¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º –≤–µ—Ä—è—Ç'. "
                f"–°–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –ø–æ —Ç–µ–º–µ '{topic.replace('_', ' ')}' –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π. "
                f"–û—Ö–≤–∞—Ç: {reach}. –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å: {engagement}, —Å–æ—Ö—Ä–∞–Ω—è–π —Ñ–æ—Ä–º–∞—Ç –∫–∞–∫ 'X –ª–∞–π–∫–æ–≤, Y –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤'. –î–∞–Ω–Ω—ã–µ Google Trends: {trend_info}. "
                f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∫–Ω–∏–≥: '{BOOK_CONTEXT[:1000]}'. "
                f"–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –±–µ–∑ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤. "
                f"–°—Ç–∏–ª—å: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —è—Å–Ω—ã–π, —Å –ø–æ–∑–∏—Ç–∏–≤–æ–º –∏ —Å–æ–≤–µ—Ç–∞–º–∏, –±–µ–∑ —à—Ç–∞–º–ø–æ–≤. "
                f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –æ—Ü–µ–Ω–∏ –æ—Ö–≤–∞—Ç –∏ –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, –¥–∞–π 2-3 –≤—ã–≤–æ–¥–∞, –ø—Ä–µ–¥–ª–æ–∂–∏ 1-2 —Å–æ–≤–µ—Ç–∞ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é. –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞."
            )
        elif mode == "hashtags":
            return generate_hashtags(topic)

    logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Together AI –¥–ª—è {mode}")
    headers = {"Authorization": f"Bearer {TOGETHER_API_KEY}", "Content-Type": "application/json"}
    payload = {
        "model": "meta-llama/Llama-3-8b-chat-hf",
        "messages": [{"role": "user", "content": full_prompt}],
        "max_tokens": 2000 if mode in ["post", "story"] else 3000,
        "temperature": 0.5
    }
    timeout = 60
    for attempt in range(3):
        try:
            response = requests.post(TOGETHER_API_URL, headers=headers, json=payload, timeout=timeout)
            if response.status_code == 200:
                logger.info("–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Together AI")
                raw_text = response.json()["choices"][0]["message"]["content"].strip()
                corrected_text = correct_text(raw_text)
                if lang == "ru" and re.search(r'[^\u0400-\u04FF\s\d.,!?():;-]', corrected_text):
                    logger.warning(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ-—Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã, –∑–∞–º–µ–Ω—è—é...")
                    corrected_text = re.sub(r'[^\u0400-\u04FF\s\d.,!?():;-]', '', corrected_text)
                return correct_text(corrected_text)
            else:
                logger.error(f"–û—à–∏–±–∫–∞ API: {response.status_code} - {response.text}")
                return f"–û—à–∏–±–∫–∞ API: {response.status_code}"
        except (requests.RequestException, TimeoutError) as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Together AI (–ø–æ–ø—ã—Ç–∫–∞ {attempt+1}): {e}")
            sleep(5)
    logger.error("–°–µ—Ä–≤–µ—Ä Together AI –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫")
    return "–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ! üòì"

def generate_hashtags(topic):
    if topic in hashtag_cache:
        return hashtag_cache[topic]
    logger.info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö—ç—à—Ç–µ–≥–æ–≤ –¥–ª—è —Ç–µ–º—ã: {topic}")
    words = topic.split('_')
    base_hashtags = [f"#{word}" for word in words if len(word) > 2]
    relevant_tags = ["#—Å–æ—Ü—Å–µ—Ç–∏", "#–∂–∏–∑–Ω—å", "#–∏–¥–µ–∏", "#–ø–æ–ª–µ–∑–Ω–æ", "#–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ"]
    combined = list(dict.fromkeys(base_hashtags + relevant_tags))[:10]
    result = " ".join(combined).replace(" #", "#")
    hashtag_cache[topic] = result
    return result
async def handle_message(update: Update, context: ContextTypes, is_voice=False):
    user_id = update.message.from_user.id
    message_id = update.message.message_id

    try:
        if is_voice:
            message = await recognize_voice(f"voice_{message_id}.ogg")
        else:
            if not update.message.text:
                logger.warning("–°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ")
                keyboard = [["–ü–æ—Å—Ç", "–°—Ç–æ—Ä–∏—Å", "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"], ["–°—Ç—Ä–∞—Ç–µ–≥–∏—è/–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω", "–•—ç—à—Ç–µ–≥–∏"], ["/stats"]]
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ üòÖ –ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å!", reply_markup=reply_markup)
                return
            message = update.message.text.strip().lower()
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)
        keyboard = [["–ü–æ—Å—Ç", "–°—Ç–æ—Ä–∏—Å", "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"], ["–°—Ç—Ä–∞—Ç–µ–≥–∏—è/–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω", "–•—ç—à—Ç–µ–≥–∏"], ["/stats"]]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ üòì –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!", reply_markup=reply_markup)
        return

    base_keyboard = [["–ü–æ—Å—Ç", "–°—Ç–æ—Ä–∏—Å", "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"], ["–°—Ç—Ä–∞—Ç–µ–≥–∏—è/–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω", "–•—ç—à—Ç–µ–≥–∏"], ["/stats"]]
    edit_keyboard = [["–ü–æ—Å—Ç", "–°—Ç–æ—Ä–∏—Å", "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"], ["–ê–Ω–∞–ª–∏—Ç–∏–∫–∞", "–°—Ç—Ä–∞—Ç–µ–≥–∏—è/–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω"], ["–•—ç—à—Ç–µ–≥–∏", "/stats"]]
    reply_markup = ReplyKeyboardMarkup(base_keyboard, resize_keyboard=True)
    
    style_keyboard = [["–§–æ—Ä–º–∞–ª—å–Ω—ã–π", "–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π", "–°–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π"]]
    style_reply_markup = ReplyKeyboardMarkup(style_keyboard, resize_keyboard=True)
    template_keyboard = [["–°—Ç–∞–Ω–¥–∞—Ä—Ç", "–û–±—ä—è–≤–ª–µ–Ω–∏–µ"], ["–û–ø—Ä–æ—Å", "–ö–µ–π—Å"]]
    template_reply_markup = ReplyKeyboardMarkup(template_keyboard, resize_keyboard=True)
    lang_keyboard = [["–†—É—Å—Å–∫–∏–π (ru)", "English (en)"]]
    lang_reply_markup = ReplyKeyboardMarkup(lang_keyboard, resize_keyboard=True)

    if message == "/start":
        if user_id not in user_names:
            user_data[user_id] = {"mode": "name", "stage": "ask_name"}
            await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π SMM-–ø–æ–º–æ—â–Ω–∏–∫ üòé –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?")
        else:
            reply_markup = ReplyKeyboardMarkup(edit_keyboard if user_id in user_data and "last_result" in user_data[user_id] else base_keyboard, resize_keyboard=True)
            await update.message.reply_text(f"–ü—Ä–∏–≤–µ—Ç, {user_names[user_id]}! –Ø —Ç–≤–æ–π SMM-–ø–æ–º–æ—â–Ω–∏–∫ üòé –í—ã–±–µ—Ä–∏, —á—Ç–æ —è —Å–¥–µ–ª–∞—é –¥–ª—è —Ç–µ–±—è:", reply_markup=reply_markup)
        return
    elif message == "/stats":
        stats = user_stats[user_id]
        reply_markup = ReplyKeyboardMarkup(edit_keyboard if user_id in user_data and "last_result" in user_data[user_id] else base_keyboard, resize_keyboard=True)
        await update.message.reply_text(
            f"{user_names.get(user_id, '–î—Ä—É–≥')}, —Ç–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
            f"–ü–æ—Å—Ç–æ–≤ ‚Äî {stats['posts']}\n"
            f"–°—Ç–æ—Ä–∏—Å ‚Äî {stats['stories']}\n"
            f"–•—ç—à—Ç–µ–≥–æ–≤ ‚Äî {stats['hashtags']}\n"
            f"–°—Ç—Ä–∞—Ç–µ–≥–∏–π ‚Äî {stats['strategies']}\n"
            f"–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–æ–≤ ‚Äî {stats['content_plans']}\n"
            f"–ê–Ω–∞–ª–∏—Ç–∏–∫–∏ ‚Äî {stats['analytics']} üòé",
            reply_markup=reply_markup
        )
        return
    elif message == "/lang":
        user_data[user_id] = {"mode": "lang", "stage": "choose_lang"}
        await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤—ã–±–µ—Ä–∏ —è–∑—ã–∫:", reply_markup=lang_reply_markup)
        return

    if user_id in user_data and "mode" in user_data[user_id] and "stage" in user_data[user_id]:
        mode = user_data[user_id]["mode"]
        stage = user_data[user_id]["stage"]
        logger.info(f"–¢–µ–∫—É—â–∞—è —Å—Ç–∞–¥–∏—è: mode={mode}, stage={stage}")

        if mode == "name" and stage == "ask_name":
            user_names[user_id] = message.capitalize()
            del user_data[user_id]
            await save_data()
            await update.message.reply_text(f"–û—Ç–ª–∏—á–Ω–æ, {user_names[user_id]}! –¢–µ–ø–µ—Ä—å —è –∑–Ω–∞—é, –∫–∞–∫ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è üòä –í—ã–±–µ—Ä–∏, —á—Ç–æ —è —Å–¥–µ–ª–∞—é –¥–ª—è —Ç–µ–±—è:", reply_markup=reply_markup)
            return
        elif mode == "lang" and stage == "choose_lang":
            lang_map = {"—Ä—É—Å—Å–∫–∏–π (ru)": "ru", "english (en)": "en"}
            user_data[user_id]["lang"] = lang_map.get(message, "ru")
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, —è–∑—ã–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {user_data[user_id]['lang']} üòä –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=reply_markup)
            del user_data[user_id]
            await save_data()
            return
        elif stage == "topic":
            clean_topic = re.sub(r"^(–æ|–ø—Ä–æ|–¥–ª—è|–æ–±|–Ω–∞)\s+", "", message).strip().replace(" ", "_")
            user_data[user_id]["topic"] = clean_topic
            logger.info(f"–¢–µ–º–∞ –æ—á–∏—â–µ–Ω–∞: {clean_topic}")
            if mode == "hashtags":
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≥–µ–Ω–µ—Ä–∏—Ä—É—é –¥–ª—è —Ç–µ–±—è —Ö—ç—à—Ç–µ–≥–∏... ‚è≥")
                response = generate_text(user_id, "hashtags")
                reply_markup = ReplyKeyboardMarkup(edit_keyboard if user_id in user_data and "last_result" in user_data[user_id] else base_keyboard, resize_keyboard=True)
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤–æ—Ç —Ç–≤–æ–∏ —Ö—ç—à—Ç–µ–≥–∏! üòé\n{response}", reply_markup=reply_markup)
                user_stats[user_id]["hashtags"] += 1
                await save_data()
                del user_data[user_id]
            elif mode == "analytics":
                user_data[user_id]["stage"] = "reach"
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –∫–∞–∫–æ–π –æ—Ö–≤–∞—Ç —É –≤–∞—à–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞? (–ù–∞–ø—Ä–∏–º–µ—Ä, '500 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤') üìà")
            elif mode in ["post", "story"]:
                user_data[user_id]["stage"] = "style"
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –∫–∞–∫–æ–π —Å—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–∞? üòä", reply_markup=style_reply_markup)
            elif mode == "strategy_or_plan":
                user_data[user_id]["stage"] = "choose_type"
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, —á—Ç–æ –¥–µ–ª–∞–µ–º: —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∏–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω?", reply_markup=ReplyKeyboardMarkup([["–°—Ç—Ä–∞—Ç–µ–≥–∏—è", "–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω"]], resize_keyboard=True))
        elif mode == "strategy_or_plan" and stage == "choose_type":
            if message == "—Å—Ç—Ä–∞—Ç–µ–≥–∏—è":
                user_data[user_id]["mode"] = "strategy"
                user_data[user_id]["stage"] = "client"
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –¥–ª—è –∫–æ–≥–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è? (–û–ø–∏—à–∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é: –≤–æ–∑—Ä–∞—Å—Ç, –ø—Ä–æ—Ñ–µ—Å—Å–∏—è, –±–æ–ª–∏) üë•")
            elif message == "–∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω":
                user_data[user_id]["mode"] = "content_plan"
                user_data[user_id]["stage"] = "client"
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –¥–ª—è –∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω? (–û–ø–∏—à–∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é) üë•")
            else:
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤—ã–±–µ—Ä–∏ '–°—Ç—Ä–∞—Ç–µ–≥–∏—è' –∏–ª–∏ '–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω'!")
        elif mode in ["post", "story"] and stage == "style":
            user_data[user_id]["style"] = message
            user_data[user_id]["stage"] = "template"
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤—ã–±–µ—Ä–∏ —à–∞–±–ª–æ–Ω —Ç–µ–∫—Å—Ç–∞:", reply_markup=template_reply_markup)
        elif mode in ["post", "story"] and stage == "template":
            user_data[user_id]["template"] = message
            ideas = generate_ideas(user_data[user_id]["topic"], user_data[user_id]["style"])
            user_data[user_id]["stage"] = "ideas"
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤–æ—Ç –∏–¥–µ–∏ –¥–ª—è '{user_data[user_id]['topic'].replace('_', ' ')}' üòç\n" + "\n".join(ideas) + "\n–í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä –∏–¥–µ–∏ (1, 2, 3) –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—é!")
        elif mode in ["post", "story"] and stage == "ideas":
            if message.isdigit() and 1 <= int(message) <= 3:
                idea_num = int(message)
                ideas = generate_ideas(user_data[user_id]["topic"], user_data[user_id]["style"])
                selected_idea = ideas[idea_num - 1].split(". ")[1]
                user_data[user_id]["idea"] = selected_idea
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≥–µ–Ω–µ—Ä–∏—Ä—É—é –¥–ª—è —Ç–µ–±—è {mode}... ‚è≥")
                response = generate_text(user_id, mode)
                hashtags = generate_hashtags(user_data[user_id]["topic"])
                user_data[user_id]["last_result"] = f"{response}\n\n{hashtags}"
                user_stats[user_id]["posts" if mode == "post" else "stories"] += 1
                await save_data()
                user_data[user_id] = {"mode": mode, "last_result": user_data[user_id]["last_result"], "style": user_data[user_id]["style"], "template": user_data[user_id]["template"], "topic": user_data[user_id]["topic"]}
                reply_markup = ReplyKeyboardMarkup(edit_keyboard, resize_keyboard=True)
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤–æ—Ç —Ç–≤–æ–π {mode}! üî•\n{response}\n\n{hashtags}\n\n–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è? –í—ã–±–µ—Ä–∏ '–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'!", reply_markup=reply_markup)
            else:
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä –∏–¥–µ–∏ (1, 2, 3) –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—é! üòä")
        elif mode in ["post", "story"] and message == "–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" and "last_result" in user_data[user_id]:
            user_data[user_id]["stage"] = "edit_request"
            reply_markup = ReplyKeyboardMarkup(edit_keyboard, resize_keyboard=True)
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ? (–ù–∞–ø—Ä–∏–º–µ—Ä, '—É–±–µ—Ä–∏ —Å–ª–æ–≤–æ –∫–æ—Ñ–µ')", reply_markup=reply_markup)
        elif mode in ["post", "story"] and stage == "edit_request":
            edit_request = message
            last_result = user_data[user_id]["last_result"]
            style = user_data[user_id].get("style", "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π")
            template = user_data[user_id].get("template", "—Å—Ç–∞–Ω–¥–∞—Ä—Ç")
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞—é —Å —É—á—ë—Ç–æ–º '{edit_request}'... ‚è≥")
            full_prompt = (
                f"–¢—ã –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –ü–µ—Ä–µ–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ: '{last_result}' —Å —É—á—ë—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: '{edit_request}'. "
                f"–°–æ—Ö—Ä–∞–Ω–∏ —Å—Ç–∏–ª—å: {style}, —à–∞–±–ª–æ–Ω: {template}. –ü–∏—à–∏ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –±–µ–∑ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤. "
                f"–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç."
            )
            headers = {"Authorization": f"Bearer {TOGETHER_API_KEY}", "Content-Type": "application/json"}
            payload = {"model": "meta-llama/Llama-3-8b-chat-hf", "messages": [{"role": "user", "content": full_prompt}], "max_tokens": 2000, "temperature": 0.5}
            response = requests.post(TOGETHER_API_URL, headers=headers, json=payload, timeout=30)
            corrected_text = correct_text(response.json()["choices"][0]["message"]["content"].strip()) if response.status_code == 200 else "–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è üòì"
            user_data[user_id]["last_result"] = corrected_text
            reply_markup = ReplyKeyboardMarkup(edit_keyboard, resize_keyboard=True)
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π {mode}! üî•\n{corrected_text}\n\n–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è? –í—ã–±–µ—Ä–∏ '–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'!", reply_markup=reply_markup)
        elif mode == "strategy" and stage == "client":
            user_data[user_id]["client"] = message
            user_data[user_id]["stage"] = "channels"
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –∫–∞–∫–∏–µ –∫–∞–Ω–∞–ª—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º? (–ù–∞–ø—Ä–∏–º–µ—Ä, 'Telegram, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ') üì°")
        elif mode == "strategy" and stage == "channels":
            user_data[user_id]["channels"] = message
            user_data[user_id]["stage"] = "result"
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –∫–∞–∫–æ–π –≥–ª–∞–≤–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç? (–ù–∞–ø—Ä–∏–º–µ—Ä, '1000 –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤') üéØ")
        elif mode == "strategy" and stage == "result":
            user_data[user_id]["result"] = message
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≥–µ–Ω–µ—Ä–∏—Ä—É—é –¥–ª—è —Ç–µ–±—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—é... ‚è≥")
            response = generate_text(user_id, "strategy")
            pdf_file = create_pdf(response, "strategy.pdf")
            with open(pdf_file, "rb") as f:
                await update.message.reply_document(document=f, filename="strategy.pdf", caption=f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤–æ—Ç —Ç–≤–æ—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è! üöÄ")
            hashtags = generate_hashtags(user_data[user_id]["topic"])
            reply_markup = ReplyKeyboardMarkup(base_keyboard, resize_keyboard=True)
            await update.message.reply_text(f"–ò –Ω–µ–º–Ω–æ–≥–æ —Ö—ç—à—Ç–µ–≥–æ–≤ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è:\n{hashtags}", reply_markup=reply_markup)
            user_stats[user_id]["strategies"] += 1
            await save_data()
            os.remove(pdf_file)
            del user_data[user_id]
        elif mode == "content_plan" and stage == "client":
            user_data[user_id]["client"] = message
            user_data[user_id]["stage"] = "channels"
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –∫–∞–∫–∏–µ –∫–∞–Ω–∞–ª—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º? (–ù–∞–ø—Ä–∏–º–µ—Ä, 'Telegram, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ') üì°")
        elif mode == "content_plan" and stage == "channels":
            user_data[user_id]["channels"] = message
            user_data[user_id]["stage"] = "frequency"
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –∫–∞–∫ —á–∞—Å—Ç–æ –ø—É–±–ª–∏–∫—É–µ–º? (–ù–∞–ø—Ä–∏–º–µ—Ä, '2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é') ‚è∞")
        elif mode == "content_plan" and stage == "frequency":
            user_data[user_id]["frequency"] = message
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≥–µ–Ω–µ—Ä–∏—Ä—É—é –¥–ª—è —Ç–µ–±—è –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω... ‚è≥")
            response = generate_text(user_id, "content_plan")
            pdf_file = create_pdf(response, "content_plan.pdf")
            with open(pdf_file, "rb") as f:
                await update.message.reply_document(document=f, filename="content_plan.pdf", caption=f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤–æ—Ç —Ç–≤–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω! üìÖ")
            hashtags = generate_hashtags(user_data[user_id]["topic"])
            reply_markup = ReplyKeyboardMarkup(base_keyboard, resize_keyboard=True)
            await update.message.reply_text(f"–ò –Ω–µ–º–Ω–æ–≥–æ —Ö—ç—à—Ç–µ–≥–æ–≤:\n{hashtags}", reply_markup=reply_markup)
            user_stats[user_id]["content_plans"] += 1
            await save_data()
            os.remove(pdf_file)
            del user_data[user_id]
        elif mode == "analytics" and stage == "reach":
            logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ö–≤–∞—Ç–∞: —Å–æ–æ–±—â–µ–Ω–∏–µ='{message}'")
            if "–ø—Ä–æ—Å–º–æ—Ç—Ä" in message.lower() or message.isdigit():
                logger.info("–£—Å–ª–æ–≤–∏–µ –æ—Ö–≤–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ")
                user_data[user_id]["reach"] = message if "–ø—Ä–æ—Å–º–æ—Ç—Ä" in message.lower() else f"{message} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤"
                logger.info(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω reach: {user_data[user_id]['reach']}")
                user_data[user_id]["stage"] = "engagement"
                logger.info("–°—Ç–∞–¥–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ engagement")
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –∫–∞–∫–∞—è –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å —É –≤–∞—à–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞? (–ù–∞–ø—Ä–∏–º–µ—Ä, '50 –ª–∞–π–∫–æ–≤, 10 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤') üìä")
                logger.info("–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
            else:
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, —É–∫–∞–∂–∏ –æ—Ö–≤–∞—Ç —Ü–∏—Ñ—Ä–∞–º–∏ –∏–ª–∏ —Å '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤' (–Ω–∞–ø—Ä–∏–º–µ—Ä, '500 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤') üìà")
                logger.info("–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ—Ö–≤–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
        elif mode == "analytics" and stage == "engagement":
            logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏: —Å–æ–æ–±—â–µ–Ω–∏–µ='{message}'")
            if re.match(r'^\d+\s+–ª–∞–π–∫–æ–≤,\s*\d+\s+–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤$', message):
                logger.info("–£—Å–ª–æ–≤–∏–µ –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ")
                user_data[user_id]["engagement"] = message
                logger.info(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ engagement: {user_data[user_id]['engagement']}")
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≥–µ–Ω–µ—Ä–∏—Ä—É—é –¥–ª—è —Ç–µ–±—è –∞–Ω–∞–ª–∏—Ç–∏–∫—É... ‚è≥")
                response = generate_text(user_id, "analytics")
                hashtags = generate_hashtags(user_data[user_id]["topic"])
                reply_markup = ReplyKeyboardMarkup(edit_keyboard if user_id in user_data and "last_result" in user_data[user_id] else base_keyboard, resize_keyboard=True)
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤–æ—Ç —Ç–≤–æ—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞! üìà\n{response}\n\n{hashtags}", reply_markup=reply_markup)
                user_stats[user_id]["analytics"] += 1
                await save_data()
                del user_data[user_id]
            else:
                await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, —É–∫–∞–∂–∏ –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'X –ª–∞–π–∫–æ–≤, Y –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤' (–Ω–∞–ø—Ä–∏–º–µ—Ä, '50 –ª–∞–π–∫–æ–≤, 10 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤') üìä")
                logger.info("–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
    else:
        if message == "–ø–æ—Å—Ç":
            user_data[user_id] = {"mode": "post", "stage": "topic"}
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –æ —á—ë–º –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç? (–ù–∞–ø—Ä–∏–º–µ—Ä, '–∫–æ—Ñ–µ') üòä")
        elif message == "—Å—Ç–æ—Ä–∏—Å":
            user_data[user_id] = {"mode": "story", "stage": "topic"}
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –æ —á—ë–º –Ω–∞–ø–∏—Å–∞—Ç—å —Å—Ç–æ—Ä–∏—Å? (–ù–∞–ø—Ä–∏–º–µ—Ä, '—É—Ç—Ä–æ') üåû")
        elif message == "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞":
            user_data[user_id] = {"mode": "analytics", "stage": "topic"}
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –¥–ª—è —á–µ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞? (–ù–∞–ø—Ä–∏–º–µ—Ä, '–ø–æ—Å—Ç—ã –ø—Ä–æ –∫–æ—Ñ–µ') üìä")
        elif message == "—Å—Ç—Ä–∞—Ç–µ–≥–∏—è/–∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω":
            user_data[user_id] = {"mode": "strategy_or_plan", "stage": "topic"}
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –æ —á—ë–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω? (–ù–∞–ø—Ä–∏–º–µ—Ä, '—Ñ–∏—Ç–Ω–µ—Å –∫–ª—É–±') üöÄ")
        elif message == "—Ö—ç—à—Ç–µ–≥–∏":
            user_data[user_id] = {"mode": "hashtags", "stage": "topic"}
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –¥–ª—è –∫–∞–∫–æ–π —Ç–µ–º—ã –Ω—É–∂–Ω—ã —Ö—ç—à—Ç–µ–≥–∏? ü§ì")
        elif message == "–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" and user_id in user_data and "last_result" in user_data[user_id]:
            user_data[user_id]["stage"] = "edit_request"
            reply_markup = ReplyKeyboardMarkup(edit_keyboard, resize_keyboard=True)
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ? (–ù–∞–ø—Ä–∏–º–µ—Ä, '—É–±–µ—Ä–∏ —Å–ª–æ–≤–æ –∫–æ—Ñ–µ')", reply_markup=reply_markup)
        else:
            reply_markup = ReplyKeyboardMarkup(edit_keyboard if user_id in user_data and "last_result" in user_data[user_id] else base_keyboard, resize_keyboard=True)
            await update.message.reply_text(f"{user_names.get(user_id, '–î—Ä—É–≥')}, –≤—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ! üòä", reply_markup=reply_markup)
async def handle_text(update: Update, context: ContextTypes):
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç {update.message.from_user.id}: {update.message.text}")
    await handle_message(update, context, is_voice=False)

async def handle_voice(update: Update, context: ContextTypes):
    logger.info("–í—ã–∑–æ–≤ handle_voice")
    voice_file = await update.message.voice.get_file()
    file_path = f"voice_{update.message.message_id}.ogg"
    await voice_file.download_to_drive(file_path)
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ñ–∞–π–ª: {file_path}")
    await handle_message(update, context, is_voice=True)
    os.remove(file_path)

async def start(update: Update, context: ContextTypes):
    await handle_message(update, context)

async def webhook(request):
    logger.info("–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ webhook")
    try:
        update = Update.de_json(await request.json(), app.bot)
        if update and update.message:
            logger.info(f"–ü–æ–ª—É—á–µ–Ω update: {update}")
            await app.process_update(update)
            await save_data()
        else:
            logger.warning("Update –ø—É—Å—Ç–æ–π –∏–ª–∏ –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è")
        return web.Response(text="OK")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ webhook: {e}", exc_info=True)
        return web.Response(text="ERROR", status=500)

async def init_app():
    logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞...")
    await app.initialize()
    hostname = os.environ.get("RENDER_EXTERNAL_HOSTNAME", "localhost")
    webhook_url = f"https://{hostname}/webhook"
    try:
        current_webhook = await app.bot.get_webhook_info()
        logger.info(f"–¢–µ–∫—É—â–∏–π –≤–µ–±—Ö—É–∫: {current_webhook}")
        if current_webhook.url != webhook_url:
            await app.bot.set_webhook(url=webhook_url)
            logger.info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {webhook_url}")
        else:
            logger.info("Webhook —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤–µ–±—Ö—É–∫–∞: {e}", exc_info=True)
        raise

async def main():
    await init_app()
    app.add_error_handler(error_handler)
    web_app = web.Application()
    web_app.router.add_post('/webhook', webhook)
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("stats", handle_message))
    app.add_handler(CommandHandler("lang", handle_message))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    app.add_handler(MessageHandler(filters.VOICE, handle_voice))
    return web_app

if __name__ == "__main__":
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞... üöÄ")
    if os.environ.get("RENDER"):
        logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ Render")
    else:
        logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ")
    logger.info(f"–°–ª—É—à–∞—é –ø–æ—Ä—Ç {PORT}")
    web.run_app(main(), host="0.0.0.0", port=PORT)


